<?xml version='1.0' encoding='utf-8'?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" epub:prefix="z3998: http://www.daisy.org/z3998/2012/vocab/structure/#" lang="en" xml:lang="en">
  <head>
    <title>WEB BASED CSOUND</title>
  </head>
  <body><h1>WEB BASED CSOUND</h1><h2>Using Csound via UDP with the --port Option</h2>
<p>The --port=N option allows users to send orchestras to be
compiled on-the-fly by Csound via UDP connection. This way, Csound
can be started with no instruments, and will listen to messages
sent to it. Many programs are capable of sending UDP messages, and
scripting languages, such as Python, can also be used for this
purpose. The simplest way of trying out this option is via the
netcat program, which can be used in the terminal via the nc
command.</p>
<p>Let's explore this as an example of the --port option. First,
Csound is started with the following command:</p>
<pre>$ csound -odac --port=1234</pre>
<p>Alternatively, if using a frontend such as CsoundQT, it is
possible run an empty CSD, with the --port in its CsOptions
field:</p>
<pre>&lt;CsoundSynthesizer&gt;
&lt;CsOptions&gt;
--port=1234
&lt;/CsOptions&gt;
&lt;CsInstruments&gt;
&lt;/CsInstruments&gt;
&lt;CsScore&gt;
&lt;/CsScore&gt;
&lt;/CsoundSynthesizer&gt;</pre>
<p>This will start Csound in a daemon mode, waiting for any UDP
messages in port 1234. Now with netcat, orchestra code can be sent
to Csound. A basic option is to use it interactively in the
terminal, with a heredocument command (&lt;&lt;) to indicate the
end of the orchestra we are sending:</p>
<pre>$ nc -u 127.0.0.1 1234 &lt;&lt; EOF
&gt; instr 1
&gt; a1 oscili p4*0dbfs,p5
&gt; out a1
&gt; endin
&gt; schedule 1,0,1,0.5,440
&gt; EOF</pre>
<p>Csound will respond with a 440Hz sinewave. The ctl-c key
combination can be used to close nc and go back to the shell
prompt. Alternatively, we could write our orchestra code to a file
and then send it to Csound via<br/>
the following command (orch is the name of our file):</p>
<pre>$ nc -u 127.0.0.1 1234 &lt; orch</pre>
<p>Csound performance can be stopped in the usual way via ctl-c in
the terminal, or through the dedicated<br/>
transport controls in a frontend. We can also close the server it
via a special UDP message:</p>
<pre><span>ERROR WITH MACRO close</span></pre>
<p>However, this will not close Csound, but just stop the UDP
server.</p>
<p><br/></p>
<h2>pNaCl - Csound for Portable Native Client</h2>
<p>Native Client (NaCl) is a sandboxing technology developed by
Google that allows C/C++ modules to extend the support provided by
HTML5. Portable Native Client (pNaCl) is one of the toolchains in
the NaCl SDK (the others are newlib and glibc). The advantage of
pNaCl over the other options is that it only requires a single
module to be built for all supported architectures.</p>
<p>The other major advantage is that pNaCl is, as of Google Chrome
31, enabled by default in the browser. This means that users just
need to load a page containing the pNaCl application and it will
work. pNaCl modules are compiled to llvm bytecode that is
translated to a native binary by the browser. To check whether your
version of Chrome supports pNaCl, use the following
address: </p>
<pre>chrome://nacl
</pre>
<p>The pNaCl Csound implementation allows users to embed the system
in web pages. With a minimal use of Javascript, it is possible to
create applications and frontends for Csound, to be run inside a
web browser (Chrome, Chromium). </p>
<p>A binary package for pNaCl-Csound can be found in the Csound
releases <a href="http://sourceforge.net/projects/csound/files/csound6"><span>http://sourceforge.net/projects/csound/files/csound6</span></a></p>
<p>Running the example application<br/></p>
<p>NaCl pages need to be served over http, which means they will
not work when opened as local files. For this you will need a http
server. A minimal one, written in Python, can be found in the NaCl
SDK <a href="https://developer.chrome.com/native-client/sdk/download"><span>https://developer.chrome.com/native-client/sdk/download</span></a>. </p>
<h3>Csound pNaCl module reference</h3>
<p>The interface to Csound is found in the csound.js javascript
file. Csound is ready on module load, and can accept control
messages from then on. </p>
<h4>Control functions</h4>
<p>The following control functions can be used to interact with
Csound:</p>
<ul>
<li><strong>csound.Play()</strong> - starts performance</li>
<li><strong>csound.PlayCsd(s)</strong> - starts performance from a
CSD file s, which can be in ./http/ (ORIGIN server) or ./local/
(local sandbox).</li>
<li><strong>csound.RenderCsd(s)</strong> - renders a CSD file s,
which can be in ./http/ (ORIGIN server) or ./local/ (local
sandbox), with no RT audio output. The “finished render” message is
issued on completion.</li>
<li><strong>csound.Pause()</strong> - pauses performance</li>
<li><strong>csound.StartAudioInput()</strong> - switches on audio
input (available in Chrome version 36 onwards)</li>
<li><strong>csound.CompileOrc(s)</strong> - compiles the Csound
code in the string s</li>
<li><strong>csound.ReadScore(s)</strong> - reads the score in the
string s (with preprocessing support)</li>
<li><strong>csound.Event(s)</strong> - sends in the line events
contained in the string s (no preprocessing)</li>
<li><strong>csound.SetChannel(name, value)</strong> - sends the
control channel name the value value.</li>
<li><strong>csound.SetStringChannel(name, string)</strong> - sends
the string channel name the string string.</li>
<li><strong>csound.SetTable(num, pos, value)</strong> - sets the
table name at index pos the value value.</li>
<li><strong>csound.RequestTable(num)</strong> - requests the table
data for table num. The “Table::Complete” message is issued on
completion.</li>
<li><strong>csound.GetTableData()</strong> - returns the most
recently requested table data as an ArrayObject.</li>
<li><strong>MIDIin(byte1, byte2, byte3)</strong> - sends a MIDI in
message to Csound.</li>
<li><strong>NoteOn(channel,number,velocity)</strong> - sends a Note
ON message to Csound.</li>
<li><strong>NoteOff(channel,number,velocity)</strong> - sends a
Note OFF message to Csound.</li>
<li><strong>PolyAftertouch(channel,number,aftertouch)</strong> -
sends a polyphonic aftertouch message to Csound.</li>
<li><strong>ControlChange(channel,control,amount)</strong> - sends
a control change message to Csound.</li>
<li><strong>ProgramChange(channel,control)</strong> - sends a
program change message to Csound.</li>
<li><strong>Aftertouch(channel,amount)</strong> - sends a mono
aftertouch message to Csound.</li>
<li><strong>PitchBend(channel,fine,coarse)</strong> - sends a
pitchbend message to Csound</li>
</ul>
<h4>Filesystem functions </h4>
<p>In order to facilitate access to files, the following filesystem
functions can be used: </p>
<ul>
<li><strong>csound.CopyToLocal(src, dest)</strong> - copies the
file src in the ORIGIN directory to the local file dest, which can
be accessed at ./local/dest. The “Complete” message is issued on
completion.</li>
<li><strong>csound.CopyUrlToLocal(url,dest)</strong> - copies the
url url to the local file dest, which can be accessed at
./local/dest. Currently only ORIGIN and CORS urls are allowed
remotely, but local files can also be passed if encoded as urls
with the webkitURL.createObjectURL() javascript method. The
“Complete” message is issued on completion.</li>
<li><strong>csound.RequestFileFromLocal(src)</strong> - requests
the data from the local file src. The “Complete” message is issued
on completion.</li>
<li><strong>csound.GetFileData()</strong> - returns the most
recently requested file data as an ArrayObject.<br/></li>
</ul>
<h4>Callbacks</h4>
<p>The csound.js module will call the following window functions
when it starts:</p>
<ul>
<li><strong>function moduleDidLoad()</strong>: this is called as
soon as the module is loaded</li>
<li><strong>function handleMessage(message)</strong>: called when
there are messages from Csound (pnacl module). The string
message.data contains the message.</li>
<li><strong>function attachListeners()</strong>: this is called
when listeners for different events are to be attached.<br/></li>
</ul>
<p>You should implement these functions in your HTML page script,
in order to use the Csound javascript interface. In addition to the
above, Csound javascript module messages are always sent to the
HTML element with id=‘console’, which is normally of type
<span>&lt;</span>div<span>&gt;</span> or <span>&lt;</span>textarea<span>&gt;</span>. </p>
<h3>Example</h3>
<p>Here is a minimal HTML example showing the use of Csound.</p>
<pre>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;!--
 Csound pnacl minimal example
 Copyright (C) 2013 V Lazzarini
--&gt;
&lt;head&gt;
 &lt;title&gt;Minimal Csound Example&lt;/title&gt;
 &lt;script type="text/javascript" src="csound.js"&gt;&lt;/script&gt;
 &lt;script type="text/javascript"&gt;
 // called by csound.js
function moduleDidLoad() {
  csound.Play();
  csound.CompileOrc(
  "instr 1 \n" +
  "icps = 440+rnd(440) \n" +
  "chnset icps, \"freq\" \n" +
  "a1 oscili 0.1, icps\n" +
  "outs a1,a1 \n" +
  "endin");
  document.getElementById("tit").innerHTML = "Click on the page below to play";
 }
 function attachListeners() {
   document.getElementById("mess").
       addEventListener("click",Play);
 }
 function handleMessage(message) {
   var mess = message.data;
   if(mess.slice(0,11) == "::control::") {
   var messField = document.getElementById("console")
   messField.innerText = mess.slice(11);
   }
   else {
   var messField = document.getElementById("mess")
   messField.innerText += mess;
   csound.RequestChannel("freq");
  }
 }

 // click handler
 function Play() {
   csound.Event("i 1 0 5");
 }
 &lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div id="console"&gt;&lt;/div&gt;
   &lt;h3 id="tit"&gt; &lt;/h3&gt;
  &lt;div id="mess"&gt;

  &lt;/div&gt;
  &lt;!--pNaCl csound module--&gt;
  &lt;div id="engine"&gt;&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
<h3>Limitations<br/></h3>
<p>The following limitations apply:</p>
<ul>
<li>MIDI is implemented so that Csound MIDI opcodes can be used.
MIDI hardware interface needs to be provided in Javascript by
another library (e.g. WebMIDI).</li>
<li>no plugins, as pNaCl does not support dlopen() and friends.
This means some opcodes are not available as they reside in plugin
libraries. It might be possible to add some of these opcodes
statically to the Csound pNaCl library in the future.<br/></li>
</ul>
<p>More information on Csound for pNaCl can be found <a href="http://vlazzarini.github.io/">http://vlazzarini.github.io/</a>.</p>
<p/><div class="group_img"><div class="image"><img src="static/pnacl.png" alt=""/> </div></div>
<p> </p>
<h2 id="csoundemscripten-a-javascript-library-for-csound-on-the-web">
libcsound.js - Csound as a Javascript Library</h2>
<h3 id="introduction">Introduction</h3>
<h3 id="introduction"><span><span>The javascript build of Csound
allows any standards compliant web browser to run an instance of
Csound in a web page without the need for plugins or add ons. This
is made possible by using</span> <a href="http://Emscripten.org">Emscripten</a><span>, a program that can
convert software written in C (such as Csound) into Javascript,
allowing it to be run natively within any web browser that supports
modern web standards.</span></span></h3>
<h3 id="caveats">Caveats</h3>
<p>The javascript build of Csound is currently in early stages of
development and therefore there are a number of caveats and
limitations with its current implementation which should be
noted.</p>
<ul>
<li>
<p>Emscripten generates a highly optimisable subset of Javascript
called <a href="http://asmjs.org"><em>asm.js</em></a>. This allows
Javascript engines which have been optimised for this subset to
achieve substantial performance increases over other Javascript
engines. At this time the only Javascript engine that supports
asm.js optimisations is the Spider Monkey engine which is part of
Firefox. Therefore the Emscripten build of Csound will perform best
on the current version of Firefox.</p>
</li>
<li>
<p>At this time, due to the design of the Web Audio API, the Csound
javascript library can only execute within the main thread of a web
page. This means that it must pause execution of any performance
when any other process that uses the main thread (such as the UI)
needs to execute. This can cause dropouts and/or glitching of the
audio during a performance.</p>
</li>
<li>
<p>As this project is in its infancy, there are a minimal number of
routines implemented so far in order to instantiate, compile and
perform a .csd file. Additional routines will be added over time as
the project matures.</p>
</li>
</ul>
<h3 id="getting-csoundemscripten">Getting libcsound.js</h3>
<p>The javascript build of Csound now comes as part of the regular
distribution of the Csound source code. It can be found in the
<em>emscripten</em> folder which also contains a markdown file that
gives the instructions on how to compile the javascript
library. </p>
<h3 id="using-csoundemscripten">Using libcsound.js</h3>
<p>In order to demonstrate how to use the Csound javascript
library, what follows is a tutorial which shows the steps necessary
to create a simple website that can open .csd files, compile them,
and play them back from the browser.</p>
<h4 id="create-a-simple-website">Create a simple website</h4>
<p>First create a new folder for the website and copy the
libcsound.js and libcsound.js.mem  files from the
emscripten/dist directory into the new websites directory. Next,
create an index.html file at the top level of the new websites
directory that contains the following minimal html code:</p>
<pre><code>&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="content-type" content="text/html; charset=utf-8"&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<h4 id="instantiate-csound">Instantiate Csound</h4>
<p>We need to write some Javascript to create an instance of
CsoundObj, so within the body tags ad new script tags and insert
the following code:</p>
<pre><code>&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="content-type" content="text/html; charset=utf-8"&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;script src="libcsound.js"&gt;&lt;/script&gt;
&lt;script&gt;
Module['noExitRuntime'] = true;
Module['_main'] = function() {

    var csoundObj = new CsoundObj();

};
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>The <em>Module</em> functions within this code are related
to how emscripten built javascript libraries execute when a webpage
is loaded. The <em>noExitRuntime</em> variable sets whether
the emscripten runtime environment is exited once the main function
has finished executing. The <em>_main</em> variable is
actually a function that is executed as soon as the webpage has
finished loading. Csound itself is instantiated using a
constructor for the <em>CsoundObj</em> object. This object
provides all the methods for directly interacting with the current
running instance of csound.</p>
<p>The Javascript console of the web browser should now show some
messages that give the version number of Csound, the build date and
the version of libsndfile being used by Csound.</p>
<p> <strong>Upload .csd file to Javascript File
System</strong></p>
<p>In order to run a .csd file from the Csound javascript library,
we first need to upload the file from the local file system to the
javascript virtual file system. In the emscripten/examples
directory there is the <em>FileManager.js</em> file that
provides an object which greatly simplifies the process of
uploading files to the virtual file system. Copy
<em>FileManager.js</em> to the root directory of the web page.</p>
<pre>&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="content-type" content="text/html; charset=utf-8"&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;script src="libcsound.js"&gt;&lt;/script&gt;
&lt;script src="FileManager.js"&gt;&lt;/script&gt;
&lt;script&gt;
Module['noExitRuntime'] = true;
Module['_main'] = function() {

    var csoundObj = new CsoundObj();

    var fileManger = new FileManager(['csd'], console.log);

    fileManger.fileUploadFromServer("test.csd", function() {

        csoundObj.compileCSD("test.csd");
    });
};
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
<p>As can be seen in the code above, the file manager is
instantiated with two arguments. The first argument is an array of
strings which tells the file manager instance which file extensions
that are permitted to be uploaded. The second argument is the
function with which the file manger will print error messages, in
this case it will print to the javascript console. The file
managers upload method also takes two arguments. The first argument
is the files path relative to the website root directory and the
second is the function to execute when the file has been
successfully uploaded. In this case when the file has been uploaded
csound will compile the .csd file.</p>
<p>If the web page is reloaded now, the file <em>test.csd</em> will
be uploaded to the javascript file system and csound will compile
it making it ready for performance.</p>
<h3><strong>Running Csound </strong></h3>
<p>Once the .csd file has been compiled csound can execute a
performance. In the following code we will create an html button
and add some code to the button so that when pressed it will run a
performance of csound. </p>
<pre>&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="content-type" content="text/html; charset=utf-8"&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;script src="libcsound.js"&gt;&lt;/script&gt;
&lt;script src="FileManager.js"&gt;&lt;/script&gt;
&lt;script&gt;
Module['noExitRuntime'] = true;
Module['_main'] = function() {

    var csoundObj = new CsoundObj();

    var fileManger = new FileManager(['csd'], console.log);

    fileManger.fileUploadFromServer("test.csd", function() {

        csoundObj.compileCSD("test.csd");
    });

    var startButton = document.createElement("BUTTON");
    startButton.innerHTML = "Start Csound";
    startButton.onclick = function() {

        csoundObj.start();
    };

    document.body.appendChild(startButton);
};
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;<span> </span></pre>
<p>Here we can see that the button <em>startButton</em> is
instantiated using the <em>document.createElement</em> method. The
buttons label is set using the <em>innerHTML</em> method, and we
can set the buttons action by defining a function and assigning it
to the buttons <em>onclick</em> method. The function simply
calls the <em>start</em> method from <em>CsoundObj.</em> The
button is then added to the DOM using
<em>document.body.appendChild</em>. </p>
<p>If the page is reloaded there should now be a button present
that is labelled with the text "Start Csound". When the button is
pressed csound should perform the .csd file which was uploaded to
the javascript file system. </p>
<h4 id="implement-file-upload-facility">
<span>CsoundOb</span><span>j.js Reference</span></h4>
<p><strong><em>CsoundObj.compileCSD(fileName)</em></strong></p>
<p>This method takes as its argument the address of a CSD file
<em>fileName</em> and compiles it for performance. The CSD file
must be present in Emscripten's javascript virtual filesystem.</p>
<hr/>
<p><strong><em>CsoundObj.disableAudioInput()</em></strong></p>
<p>This method disables audio input to the web browser. Audio input
will not be available to the running Csound instance</p>
<hr/>
<p><strong><em>CsoundObj.enableAudioInput()</em></strong></p>
<p>This method enables audio input to the web browser. When called,
it triggers a permissions dialogue in the host web browser
requesting permission to allow audio input. If permission is
granted, audio input is available for the running Csound
instance. </p>
<hr/>
<p><strong><em>CsoundObj.enableMidiInput()</em></strong></p>
<p>This method enables Midi input to the web browser. When
activated on supported browsers (currently only Chrome supports web
midi) it is possible for the running instance of Csound to receive
midi messages from a compatible input device.</p>
<hr/>
<p><strong><em>CsoundObj.evaluateCode()</em></strong></p>
<p>This method takes a string of Csound orchestra code and
evaluates it on the fly. Any instruments contained in the code will
be created and added to the running Csound process.</p>
<hr/>
<p><strong><em>CsoundObj.readScore()</em></strong></p>
<p>This method takes a string of Csound score code and evaluates
it.</p>
<hr/>
<p><strong><em>CsoundObj.render()</em></strong></p>
<p>This method renders the currently compiled .csd file as quickly
as possible. This method is currently only used to evaluate the
performance of libcsound.js and is of no practical use to end
users.</p>
<hr/>
<p><strong><em>CsoundObj.reset()</em></strong></p>
<p>This method resets the currently running instance of Csound.
This method should be called before a new .csd file needs to be
read and compiled for performance.</p>
<hr/>
<p><strong><em>CsoundObj.setControlChannel()</em></strong></p>
<p>This method sets a named Csound control channel to a specified
value.</p>
<hr/>
<p><strong><em>CsoundObj.setControlChannel()</em></strong></p>
<p>This method gets the current value of a named Csound control
channel. </p>
<hr/>
<p><strong><em>CsoundObj.start()</em></strong></p>
<p>This method starts a performance of a compiled .csd file.</p>
</body>
</html>
